@using ACC.ViewModels.MemberVM
@using ACC.ViewModels.MemberVM.MemberVM

@model List<MemberVM>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Account Members</title>
    <link href="/css/site.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
    <div class="d-flex">
        <div class="container-fluid p-4">
            <h2>Account Members</h2>
            <div class="d-flex justify-content-between my-3">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMemberModal">+ Add members</button>
                <div class="d-flex">
                    <input type="text" class="form-control me-2" placeholder="Search by name or email">
                    <button class="btn btn-outline-secondary">Export</button>
                </div>
            </div>

            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Company</th>
                        <th>Default Role</th>
                        <th>Access Level</th>
                        <th>Added On</th>
                        <th><i class="fas fa-cog"></i></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var member in Model)
                    {
                        <tr id="row-@member.Id" class="member-row" data-id="@member.Id">
                            <td>@member.Name</td>
                            <td>@member.Status</td>
                            <td>@member.Company</td>
                            <td>@member.Role</td>
                            <td>
                                @foreach (var accessLevel in member.AccessLevels)
                                {
                                    <span>@accessLevel</span>
                                }
                            </td>
                            <td>@member.AddedOn</td>
                            <td>
                                <div class="action-btn">
                                    <button class="btn btn-light btn-sm toggle-menu">
                                        <i class="bi bi-three-dots-vertical"></i>
                                    </button>
                                    <div class="action-menu">
                                        <button class="delete-btn" data-id="@member.Id">Delete</button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Right-Side Panel -->
        <div id="memberDetailsPanel" class="details-panel">
            <div class="panel-header">
                <div class="avatar">
                    <span id="memberInitials"></span>
                </div>
                <div class="member-info">
                    <h5 id="memberName"></h5>
                    <p class="text-muted" id="memberPhone">No phone number</p>
                    <a href="#" id="memberEmail" class="email-link"></a>
                    <span class="status-badge"></span>
                </div>
                <button id="closePanel" class="close-btn"><i class="bi bi-x"></i></button>
            </div>

            <hr>

            <div class="panel-body">
                <label>Company</label>
                <select id="memberCompany" class="form-select">
                    <option value="">Select a company (optional)</option>
                </select>

                <label>Role</label>
                <select id="memberRole" class="form-select">
                    <option value="Construction Manager">Construction Manager</option>
                </select>

                <label>Access Level</label>
                <select id="memberAccessLevel" class="form-select">
                    <option value="">Select...</option>
                </select>

                <hr>

                <h6 class="text-muted">Projects</h6>
                <p class="text-muted">0 projects</p>
            </div>
        </div>
    </div>

    <partial name="PartialViews/_AddMemberPartialView" model="new InsertMemberVM()" />

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        $(document).ready(function () {
            // Toggle custom menu
            $(document).on("click", ".toggle-menu", function (e) {
                e.stopPropagation(); // Prevent row click
                var $menu = $(this).siblings(".action-menu");
                $(".action-menu").not($menu).hide(); // Hide other menus
                $menu.toggle(); // Show/hide this menu
            });

            // Hide menu when clicking outside
            $(document).on("click", function (e) {
                if (!$(e.target).closest(".action-btn").length) {
                    $(".action-menu").hide();
                }
            });

            // Row click to open panel
            $(document).on("click", ".member-row", function (e) {
                if (!$(e.target).closest(".toggle-menu, .delete-btn").length) {
                    console.log("Row clicked, ID:", $(this).data("id"));
                    var memberId = $(this).data("id");

                    $.ajax({
                        url: "/Member/Details/" + memberId,
                        type: "GET",
                        success: function (data) {
                            console.log("AJAX response:", data);
                            $("#memberInitials").text((data.userName || "N/A").charAt(0).toUpperCase());
                            $("#memberName").text(data.userName || "N/A");
                            $("#memberEmail").text(data.email || "N/A").attr("href", "mailto:" + (data.email || ""));
                            $(".status-badge").text(data.status || "N/A");
                            $("#memberCompany").val(data.company || "");
                            $("#memberRole").val(data.role || "");
                            $("#memberAccessLevel").val(data.AccessLevels ? data.AccessLevels.join(", ") : "");
                            $("#memberDetailsPanel").addClass("show");
                        },
                        error: function () {
                            alert("Failed to load member details.");
                        }
                    });
                }
            });

            // Close panel
            $("#closePanel").click(function () {
                $("#memberDetailsPanel").removeClass("show");
            });

            // Delete member
            $(document).on("click", ".delete-btn", function (e) {
                e.preventDefault();
                e.stopPropagation();
                var memberId = $(this).data("id");
                console.log("Delete clicked, ID:", memberId);
                $(this).closest(".action-menu").hide(); // Hide menu after click
                if (confirm("Are you sure you want to delete this member?")) {
                    $.ajax({
                        url: "/Member/Delete/" + memberId,
                        type: "POST",
                        success: function () {
                            console.log("Member deleted, ID:", memberId);
                            $("#row-" + memberId).remove();
                        },
                        error: function (xhr, status, error) {
                            console.error("Delete error:", status, error);
                            alert("Failed to delete the member.");
                        }
                    });
                }
            });
        });

        //toastr
            <script>
        $(document).ready(function () {
            $("#addMemberForm").submit(function (event) {
                event.preventDefault();
                $.ajax({
                    url: "/Member/InsertMemberAsync",
                    type: "POST",
                    data: $(this).serialize(),
                    success: function (response) {
                        if (response.success) {
                            toastr.success("Member added successfully!");
                            location.reload();
                        } else {
                            toastr.error("Failed to add member.");
                        }
                    },
                    error: function () {
                        toastr.error("An error occurred.");
                    }
                });
            });

            $(".delete-btn").click(function () {
                var memberId = $(this).data("id");
                $.ajax({
                    url: "/Member/DeleteAsync",
                    type: "POST",
                    data: { id: memberId },
                    success: function () {
                        toastr.success("Member deleted successfully!");
                        location.reload();
                    },
                    error: function () {
                        toastr.error("Failed to delete member.");
                    }
                });
            });
        });
    </script>
    </script>
</body>
</html>